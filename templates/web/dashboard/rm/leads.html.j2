{%extends 'web/rm-base-dashboard.html.j2'%}
{% block title %} Referrals | Blinkx{% endblock %}
{%block custom_css%}
<style>

    h5#leadsModalLabel {
        font-size: 20px;
        font-weight: 600;
        color: #1f1f1f;
    }

    #leadsModal .close {
        top: 50px;
        right: 35px;
        background: #fff3ee;
        font-size: 1.5rem;
        padding: 6px 12px;
    }

    #leadsModal .modal-body {
        padding: 0rem 1.6rem;
        padding-bottom: 2rem;
    }

    #leadsModal .modal-header {
        padding: 1rem 1.6rem;
        padding-top: 2rem;
    }

    .form-check-input {
        height: auto !important;
    }
</style>
{%endblock%}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css"
    integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
<!-- Content Wrapper -->
<div id="content-wrapper" class="d-flex flex-column">

    <!-- Main Content -->
    <div id="content">

        <!-- Topbar -->
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top py-5 justify-content-between">

            <!-- Sidebar Toggle (Topbar) -->
<!-- deleted -->

            <!-- Topbar Search -->
            <div class="top-heading">
                <p class="h3 font-weight-600">Referrals</p>

            </div>
            {%include 'web/dashboard/_partials/rm/header.html.j2'%}

        </nav>
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
        <div class="container-fluid">



            <div class="row">
                <div class="col-12 col-xl-12 col-lg-12">
                    <div class="d-flex justify-content-end mb-3">

                        <div data-search-lead class="search-form mr-3">
                                <div class="input-group">
                                    <div class="form-outline w-xs-75">
                                        <input type="search" placeholder="Search..." class="form-control search-input" />
                                    </div>
                                    <button type="submit" class="btn gradient-btn w-auto px-3">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                        </div>

                        <select class="w-auto custom-select days-select" name="" id="">
                            <option selected disabled
                                data-display="<i class='fa fa-filter' aria-hidden='true'></i> Filter">Filter</option>
                            <option value="30">Last 30 days</option>
                            <option value="60">Last 60 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                    <div class="bg-light px-3 py-2 mb-2 rounded d-md-none d-flex align-items-center justify-content-between">
                        <p class="mb-0"> Swipe to scroll horizontally</p>
                        <img src="{{static('dashboard/img/swipe.png')}}" width="40" class="img-fluid swipe-icon" alt="swipe">
                    </div>
                    <!-- DataTales Example -->
                    <div class="card border-0 mb-4">

                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table" id="dataTable" width="100%" cellspacing="0">
                                    <thead class="bg-beige">
                                        <tr>
                                            <th>Sr No.</th>
                                            <th>Name</th>
                                            <th>DRA Code</th>
                                            <th>DRA Name</th>
                                            <th>Email Id</th>
                                            <th>Mobile No.</th>
                                            <th>date Created</th>
                                            <th class="">steps</th>
                                            <th class="">remind</th>
                                        </tr>
                                    </thead>
                                    <tbody data-leads-list>

                                    </tbody>
                                </table>
                                <div data-empty-category="" style="display: none;" class="card w-100 mt-4">
                                    <p class="h6 text-center py-5">No Data Available</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-light px-3 py-2 mb-2 rounded d-md-none d-flex align-items-center justify-content-between">
                        <p class="mb-0"> Swipe to scroll horizontally</p>
                        <img src="{{static('dashboard/img/swipe.png')}}" width="40" class="img-fluid swipe-icon" alt="swipe">
                    </div>
                </div>

            </div>
            <p id="pagination-here" class="d-flex justify-content-center"></p>

        </div>
        <!-- /.container-fluid -->

    </div>
    <!-- End of Main Content -->

    <!-- Footer -->
    <!-- <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Your Website 2021</span>
                    </div>
                </div>
            </footer> -->
    <!-- End of Footer -->

</div>
<!-- End of Content Wrapper -->


<!-- Logout Modal-->
<div class="modal fade" id="leadsModal" tabindex="-1" role="dialog" aria-labelledby="leadsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="leadsModalLabel">Add Referrals</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Ã—</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group mt-4">
                    <input name="name" type="text" id="name" class="form-control" data-mobile-value
                        aria-describedby="nameHelp" required>
                    <label class="form-control-placeholder" for="name">Your Name*</label>
                    <div id="nameHelp" class="form-text text-danger">Enter Your Name</div>
                </div>
                <div class="form-group mt-4">
                    <input name="email" type="email" id="email" class="form-control" data-mobile-value
                        aria-describedby="data-email-error" required>
                    <label class="form-control-placeholder" for="email">Enter Email Id*</label>
                    <div data-email-error class="form-text text-danger">Enter Your Email Id</div>
                </div>
                <div class="form-group mt-4">
                    <input name="mobile" type="tel" id="mobile" class="form-control" data-mobile-value
                        aria-describedby="data-mobile-error">
                    <label class="form-control-placeholder" for="mobile">Enter Mobile Number</label>
                    <div data-mobile-error class="form-text text-danger">Enter Your Mobile Number</div>
                </div>
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="exampleCheck1" required>
                    <label class="form-check-label" for="exampleCheck1">I agree to the terms and conditions</label>
                </div>
                <button class="btn gradient-btn">
                    Submit
                </button>
            </div>

        </div>
    </div>
</div>
{% endblock %}
{% block extra_footer_script %}
<script src="https://cdn.rawgit.com/botmonster/jquery-bootpag/master/lib/jquery.bootpag.min.js"></script>
<script>
const urlParams = new URLSearchParams(window.location.search);
const getName = urlParams.get('name');

 $("[data-search-lead] button").on("click", function (e) {
            var searchVal = $('.search-input').val();
            window.location = '/rm-leads/?name='+searchVal;
});

    $(".main-loader").show();
    $.ajax({
        type: "GET",
        url: "/api/rm-leads/?name="+getName,
        dataType: "json",
        success: function (response) {
            $(".main-loader").hide();
            $("[data-leads-list]").empty();
            var count = response.count;
            var total = count / 10;
            if (count > 10) {
                var total = count / 10;
            }
            else {
                total = 0
            }
            if (typeof total === "number") {
                if (total % 1 === 0) {
                    total;
                } else {
                    total = Math.floor(total + 1);
                }
            } else {
                total = 1;
            }
            $("#pagination-here").bootpag({
                total: total,
                page: 1,
                maxVisible: 5,
                leaps: true,
                href: "javascript: void(0);",
                wrapClass: "pagination",
                activeClass: "active",
                prev: ' <i class="fa fa-arrow-left" aria-hidden="true"></i>',
                next: ' <i class="fa fa-arrow-right" aria-hidden="true"></i>',
            });
            $("#pagination-here").find("a").addClass("page-link", "orange-color");
            $("#pagination-here").find("li").addClass("page-item");
            if (response.results.length == 0) {

                $('[ data-empty-category ]').show();
            }
            else {
                $.each(response.results, function (k, v) {
                    var sr = k+1;
                    var name = v.name;
                    var dra = v.dra_code;
                    var dra_name = v.dra_name;
                    var email = v.email;
                    var mobile_no = v.mobile_no;
                    var date_created = v.date_created;
                    var step = v.step;


                    $("[data-leads-list]").append(
                        "<tr class='table-row'><td>"+sr+"</td><td class='name'>" + name + "</td><td>" + dra + "</td><td>" + dra_name + "</td><td class='email'>" + email + "</td><td class='mobile'> " + mobile_no + "</td><td> " + date_created + "</td><td class=''> " + step + " </td><td class=''> <a href='#'class='dashboard-btn'>Remind</a> </td></tr>"
                    );


                });
            }

        },
        error: function (error) {
            $(".main-loader").hide();
        },
    });
    //   select ajax call
    $(".custom-select").on("change", function () {
        $(".main-loader").show();
        $.ajax({
            type: "GET",
            url: "/api/rm-leads/?name="+getName+"&days=" + this.value,
            dataType: "json",
            success: function (response) {
                $(".main-loader").hide();
                $("[data-leads-list]").empty();
                var count = response.count;
                var total = count / 10;
                if (count > 10) {
                    var total = count / 10;
                }
                else {
                    total = 0
                }
                if (typeof total === "number") {
                    if (total % 1 === 0) {
                        total;
                    } else {
                        total = Math.floor(total + 1);
                    }
                } else {
                    total = 1;
                }
                $("#pagination-here").bootpag({
                    total: total,
                    page: 1,
                    maxVisible: 5,
                    leaps: true,
                    href: "javascript: void(0);",
                    wrapClass: "pagination",
                    activeClass: "active",
                    prev: ' <i class="fa fa-arrow-left" aria-hidden="true"></i>',
                    next: ' <i class="fa fa-arrow-right" aria-hidden="true"></i>',
                });
                $("#pagination-here").find("a").addClass("page-link", "orange-color");
                $("#pagination-here").find("li").addClass("page-item");
                if (response.results.length == 0) {
                    $('[ data-empty-category ]').show();
                }
                else {
                    $.each(response.results, function (k, v) {
                        var sr = k+1;
                        var name = v.name;
                        var dra = v.dra_code;
                        var dra_name = v.dra_name;
                        var email = v.email;
                        var mobile_no = v.mobile_no;
                        var date_created = v.date_created;
                        var step = v.step;


                        $("[data-leads-list]").append(
                            "<tr class='table-row'><td>"+sr+"</td><td class='name'>" + name + "</td><td>" + dra + "</td><td>" + dra_name + "</td><td class='email'>" + email + "</td><td class='mobile'> " + mobile_no + "</td><td> " + date_created + "</td><td class=''> " + step + " </td><td class=''> <a href='#'class='dashboard-btn'>Remind</a> </td></tr>"
                        );


                    });
                }

            },
            error: function (error) {
                $(".main-loader").hide();
            },
        });
    });
    //   pagination ajax call
    $("#pagination-here").on("page", function (event, num) {
        $(".main-loader").show();
        $.ajax({
            type: "GET",
            url: "/api/rm-leads/?name="+getName+"&page=" + num,
            dataType: "json",
            success: function (response) {
                $(".main-loader").hide();
                $("[data-leads-list]").empty();
                if (response.results.length == 0) {
                    $('[ data-empty-category ]').show();
                }
                else {
                    $.each(response.results, function (k, v) {
                        var sr = k+1;
                        var name = v.name;
                        var dra = v.dra_code;
                        var dra_name = v.dra_name;
                        var email = v.email;
                        var mobile_no = v.mobile_no;
                        var date_created = v.date_created;
                        var step = v.step;


                        $("[data-leads-list]").append(
                            "<tr class='table-row'><td>"+sr+"</td><td class='name'>" + name + "</td><td>" + dra + "</td><td>" + dra_name + "</td><td class='email'>" + email + "</td><td class='mobile'> " + mobile_no + "</td><td> " + date_created + "</td><td class=''> " + step + " </td><td class=''> <a href='#'class='dashboard-btn'>Remind</a> </td></tr>"
                        );


                    });
                }

            },
            error: function (error) {
                $(".main-loader").hide();
            },
        });
    });
    $('body').on('click', '.dashboard-btn', function (e) {
        $(".main-loader").show();
        var mobile = $(event.target).closest('.table-row').children('.mobile')[0].innerHTML;
        var email = $(event.target).closest('.table-row').children('.email')[0].innerHTML;
        var name = $(event.target).closest('.table-row').children('.name')[0].innerHTML;
        var firstName = name.split(' ').slice(0, -1).join(' ');
        var lastName = name.split(' ').slice(-1).join(' ');
        console.log('mobile is', mobile, email, firstName + "and" + lastName);
        $.ajax({
            type: "POST",
            url: '/api/dra/leads/remind/',
            headers: {
                Authorization: "Bearer " + localStorage.getItem("access-token"),
            },
            data: {
                mobile: mobile,
                email: email,
                first_name: firstName,
                last_name: lastName,
            },


            success: function (data) {
                $(".main-loader").hide();
                toastr.success('referral is emailed successfully');
            },
            error: function (err) {
                $(".main-loader").hide();
                toastr.error('Something went wrong');
            },
        });

    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"
    integrity="sha512-NqYds8su6jivy1/WLoW8x1tZMRD7/1ZfhWG/jcRQLOzV1k1rIODCpMgoBnar5QXshKJGV7vi0LXLNXPoFsM5Zg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    //  $('.days-select').niceSelect();
    $('.custom-select').niceSelect();
   // $('.download-select').niceSelect();
</script>
{% endblock %}